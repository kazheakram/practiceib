<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB Mock Exam Grader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Lighter, more professional background */
            background-color: #f0f4f8; 
        }
        /* Official IB Blue - Primary */
        .ib-blue { background-color: #0077c8; } 
        .ib-blue-text { color: #0077c8; }
        .ib-blue-border { border-color: #0077c8; }
        /* IB Gold - Accent (Updated to be more prominent for the IB Grade 1-7) */
        .ib-gold-text { color: #fcc917; } 
        
        /* Professional Card Shadow */
        .card { 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.05); 
            transition: transform 0.2s ease-in-out;
        }

        /* Ensure code and answer text areas use a clean font for readability */
        #userAnswerArea {
            font-family: 'Inter', sans-serif; 
            resize: vertical; /* Allow resizing only vertically */
        }
        
        /* Custom style for the timer card */
        .timer-card {
            background: linear-gradient(135deg, #0077c8 0%, #005a99 100%);
        }
        /* Custom style to preserve line breaks within a div for the prompt display */
        /* Use pre-wrap to respect line breaks from the LLM output but allow wrapping */
        .preserve-whitespace {
            white-space: pre-wrap; 
        }

        /* Modal specific styles */
        .modal {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .modal-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none; /* Crucial for hidden modals */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" class="flex-grow flex flex-col items-center p-4 sm:p-8">
        <!-- Application Content will be rendered here -->
    </div>
    
    <!-- API Key Configuration Modal (Hidden by default) -->
    <!-- Note: This is outside #app, so delegation must be on the body/document -->
    <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 modal modal-hidden">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4" data-element="modal-content">
            <h3 class="text-2xl font-bold mb-4 ib-blue-text border-b pb-2">Gemini API Key Setup</h3>
            <p class="text-gray-700 mb-4">
                To run the AI Grader, you must provide a <b>Gemini API Key</b>. This key is saved securely in your browser's local storage.
            </p>
            <div class="mb-4">
                <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">Your Gemini API Key:</label>
                <input type="password" id="apiKeyInput" value="" placeholder="Enter your key here (sk-...)" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-ib-blue-border focus:border-ib-blue-border text-base shadow-sm">
            </div>
            <div class="flex justify-end space-x-3">
                <button data-action="saveApiKey" class="ib-blue text-white py-2 px-4 rounded-lg font-semibold transition duration-300 hover:bg-blue-800 shadow-md">
                    Save Key & Continue
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-4 text-center">
                Get your key from Google AI Studio.
            </p>
        </div>
    </div>

    <!-- Application Logic and State Management (No Firebase/Firestore) -->
    <script>
        
        const API_KEY_STORAGE_KEY = 'geminiApiKey';

        const SUBJECT_CONFIG = {
            'english': {
                name: 'English A: Language & Literature',
                rubric: [
                    { name: 'Criterion A: Knowledge, Understanding and Interpretation', max: 5 },
                    { name: 'Criterion B: Analysis and Evaluation', max: 5 },
                    { name: 'Criterion C: Focus, Organization and Development', max: 5 },
                    { name: 'Criterion D: Language', max: 5 }
                ],
                totalMarks: 20, // Sum of criteria max scores
                paper1Time: 90 * 60, // 90 minutes
                paper2Time: 90 * 60, // 90 minutes
            },
            'global_politics': {
                name: 'Global Politics',
                // This combined rubric covers P1/P2/P3 criteria for internal scoring
                rubric: [ 
                    { name: 'Criterion A: Knowledge and Understanding of Concepts and Theories', max: 5 },
                    { name: 'Criterion B: Application, Analysis, and Synthesis', max: 5 },
                    { name: 'Criterion C: Evaluation of Perspectives and Arguments', max: 5 },
                    { name: 'Criterion D: Structure and Coherence of Argument', max: 5 },
                    { name: 'Criterion E: Depth of Conceptual Understanding and Case Study Integration', max: 5 },
                    { name: 'Criterion F: Clarity and Precision of Language', max: 5 }
                ],
                // We use 30 as the maximum for the highest paper type (P3 HL), but adjust dynamically in gradePaper
                totalMarks: 30, 
                paper1Time: 75 * 60, // 75 minutes
                paper2Time: 105 * 60, // 105 minutes
                paper3Time: 90 * 60, // 90 minutes (HL only)
            }
        };
        
        const APP_STATE = {
            step: 'SUBJECT_SELECT', // SUBJECT_SELECT, LEVEL_SELECT, TOPIC_INPUT, PAPER_SELECT, EXAM_PREVIEW, EXAM_RUNNING, GRADING, RESULTS
            subject: null,
            level: null,
            topic: '',
            paper: null,
            examPrompt: null,
            examDuration: 0, // In seconds
            timeRemaining: 0,
            intervalId: null,
            userAnswer: '',
            gradingResult: null,
            isApiLoading: false,
            apiError: null,
            apiKey: localStorage.getItem(API_KEY_STORAGE_KEY) || "", // Load key from local storage
        };

        
        // --- GRADING SCHEMA (Mandatory Structured Output) ---
        const GRADING_SCHEMA = {
            type: "OBJECT",
            properties: {
                totalMarksAchieved: { type: "INTEGER", description: "The total marks achieved across all criteria." },
                ibGradeLevel: { type: "INTEGER", description: "The final IB grade awarded on the 1-7 scale, based on the total raw mark achieved and quality." },
                totalMarksPossible: { type: "INTEGER", description: "The total possible marks for the paper (20, 25, or 30)." },
                overallGradeComment: { type: "STRING", description: "A one-paragraph summary of the candidate's performance, strengths, and weaknesses." },
                criteriaBreakdown: {
                    type: "ARRAY",
                    description: "An array containing the detailed scores and comments for each grading criterion.",
                    items: {
                        type: "OBJECT",
                        properties: {
                            criterionName: { type: "STRING", description: "The full name of the grading criterion (e.g., Criterion A: Knowledge, Understanding and Interpretation)." },
                            score: { type: "INTEGER", description: "The mark awarded for this specific criterion." },
                            comment: { type: "STRING", description: "Specific feedback explaining the score for this criterion." },
                            exemplaryExcerpt: { type: "STRING", description: "A short, direct quote from the student's answer (1-3 sentences max) that best exemplifies the reason for the given score." }
                        },
                        required: ["criterionName", "score", "comment", "exemplaryExcerpt"]
                    }
                },
                suggestedImprovementEssay: { type: "STRING", description: "A detailed paragraph suggesting specific strategies for improving the essay." }
            },
            propertyOrdering: [
                "totalMarksAchieved",
                "ibGradeLevel", 
                "totalMarksPossible",
                "overallGradeComment",
                "criteriaBreakdown",
                "suggestedImprovementEssay"
            ]
        };

        // --- API Key Management ---

        function openKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            const input = document.getElementById('apiKeyInput');
            
            // Populate input with existing key if available
            input.value = APP_STATE.apiKey; 
            
            // Display modal
            modal.classList.remove('modal-hidden');
        }

        function closeKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            modal.classList.add('modal-hidden');
        }
        
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            
            if (key) {
                localStorage.setItem(API_KEY_STORAGE_KEY, key);
                APP_STATE.apiKey = key;
                closeKeyModal();
            } else {
                localStorage.removeItem(API_KEY_STORAGE_KEY);
                APP_STATE.apiKey = "";
                closeKeyModal();
            }
            // Re-render to update UI (e.g., API Key status in header)
            render();
        }


        // --- Core Functions ---

        /**
         * Generic function to safely call the Gemini API with exponential backoff.
         * @param {object} payload - The API request payload.
         * @param {string} responseMimeType - Optional, for structured JSON output.
         * @param {object} responseSchema - Optional, for structured JSON output.
         * @returns {Promise<object>} The parsed API response object.
         */
        async function callGeminiApi(payload, responseMimeType = null, responseSchema = null) {
            
            // Determine the API Key to use
            const apiKeyToUse = APP_STATE.apiKey;
            
            if (!apiKeyToUse || apiKeyToUse.length < 20) {
                 APP_STATE.apiError = "Gemini API Key is missing or invalid. Please click 'Configure Key' to enter your key.";
                 APP_STATE.isApiLoading = false;
                 render();
                 throw new Error("API Key is missing or invalid.");
            }

            APP_STATE.isApiLoading = true;
            APP_STATE.apiError = null;
            render();

            const apiKey = ""; // Canvas will inject the real key if available
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let finalPayload = { contents: payload.contents };
            if (payload.systemInstruction) {
                finalPayload.systemInstruction = payload.systemInstruction;
            }
            if (payload.tools) {
                finalPayload.tools = payload.tools;
            }

            if (responseMimeType && responseSchema) {
                finalPayload.generationConfig = {
                    responseMimeType: responseMimeType,
                    responseSchema: responseSchema,
                };
            }

            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(finalPayload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({})); 
                        let apiErrorMessage = errorBody.error?.message || 'Unknown server error (check console for details).';
                        
                        if (response.status === 401 || response.status === 403) {
                            apiErrorMessage = `Authentication failed (Status ${response.status}). Check your Gemini API key, billing status, and model access.`;
                        } else if (response.status === 400 && apiErrorMessage.includes("API key not valid")) {
                            apiErrorMessage = "The provided API key is invalid. Please re-enter it correctly via 'Configure Key'.";
                        }
                        
                        throw new Error(`API returned status ${response.status}: ${apiErrorMessage}`);
                    }
                    
                    const text = await response.text();
                    if (!text || text.trim() === "") {
                        throw new Error("Received empty response body from API. The model may have failed to generate content.");
                    }
                    
                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (parseError) {
                        console.error("Failed to parse API response JSON:", parseError, "Raw Text:", text);
                        throw new Error(`Failed to parse API response JSON. Error: ${parseError.message}. Response start: ${text.substring(0, 50)}...`);
                    }
                    
                    APP_STATE.isApiLoading = false;
                    render();
                    
                    return result;

                } catch (error) {
                    let errorMessage = error.message;
                    if (errorMessage.includes("Unknown name \"additionalProperties\"")) {
                         errorMessage = "JSON Schema Error: The grading schema is using an unsupported property ('additionalProperties'). This is an internal application error. The code needs fixing.";
                    }
                    if (errorMessage.includes("Unexpected end of input") || errorMessage.includes("Failed to parse API response JSON")) {
                         errorMessage = "The AI model returned an incomplete or malformed response. Please try again. This may happen due to prompt complexity.";
                    }
                    
                    console.error(`Attempt ${i + 1} failed:`, errorMessage);
                    if (i === maxRetries - 1) {
                        APP_STATE.isApiLoading = false;
                        APP_STATE.apiError = `Failed to connect or process after multiple retries: ${errorMessage.substring(0, 100)}...`;
                        render();
                        throw new Error(errorMessage); 
                    }
                    // Exponential backoff delay
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Generates the mock exam prompt using the Gemini API.
         */
        async function generateExamPrompt() {
            const { subject, level, topic, paper } = APP_STATE;
            const config = SUBJECT_CONFIG[subject];
            const subjectName = config.name;
            const levelName = level.toUpperCase();
            
            // Instructing the LLM to use HTML <b> tags instead of Markdown ** for clean UI rendering
            const systemPrompt = `You are a certified IB examiner for ${subjectName}. Your task is to generate a realistic, challenging, and specific mock exam question or stimulus material for a ${levelName} student. The question must be directly relevant to the user's specified topic: "${topic}". CRITICAL RULE: Output ONLY the requested exam prompt/sources and absolutely NO introductory phrases, greetings, or explanations. Use HTML <b> tags for all mandatory headings and use clear line breaks for formatting. Absolutely DO NOT use any markdown list syntax or special characters (such as -, *, or 1.) to format the sources, questions, or content. The output must be clean, professional textbook quality.`;

            let userQuery = `Generate the full prompt for an IB ${subjectName} ${levelName} Paper ${paper} exam based on the text/topic "${topic}".`;
            let tools = [];
            
            // Paper-specific instructions for structured output
            if (subject === 'english' && paper === '1') {
                userQuery += ` For Paper 1 (SL/HL), generate TWO unseen, contrasting non-literary or literary extracts. The entire response must strictly follow this structure: start with an HTML bold heading <b>Source A</b> followed by the full text of the first source. Then, include an HTML bold heading <b>Source B</b> followed by the full text of the second source. Finally, include an HTML bold heading <b>Question</b> followed by the specific comparative analysis question.`;
            } else if (subject === 'english' && paper === '2') {
                userQuery += ` For Paper 2, generate one essay question that requires the student to compare and contrast at least TWO works studied in class (one of which is specified as "${topic}"). The question must be broad enough to allow comparison with another work.`;
            } 
            
            else if (subject === 'global_politics' && paper === '1') {
                tools = [{ "google_search": {} }];
                userQuery += ` For Global Politics Paper 1, generate a stimulus-based question set consisting of THREE distinct sources that address the contemporary political issue of "${topic}". The three sources <b>MUST</b> be:
                
                1. <b>Source 1</b>: A textual excerpt from a primary source (e.g., a speech, an article).
                2. <b>Source 2 (Visual Source)</b>: A detailed, vivid description of a political cartoon or infographic that clearly represents a concept related to the topic. The description must be detailed enough to be analyzed as a visual text.
                3. <b>Source 3</b>: A short secondary textual source from an academic or analytical report.
                
                The entire response must strictly follow this structure, using ONLY HTML <b> tags for headings and line breaks, with no list markers: 
                
                <b>Source 1</b>
                [Source 1 Text]
                
                <b>Source 2</b>
                [Detailed Visual Description]
                
                <b>Source 3</b>
                [Source 3 Text]
                
                <b>Questions</b>
                (a) [Question 1]
                (b) [Question 2]
                (c) [Question 3]
                (d) [Question 4]
                
                Ensure the formatting is textbook quality with no bullet points or markdown list symbols whatsoever.`;
            } else if (subject === 'global_politics' && paper === '2') {
                userQuery += ` For Global Politics Paper 2, generate one essay question that is concept-driven and requires evaluation, applying knowledge to the issue/area of study related to "${topic}".`;
            } else if (subject === 'global_politics' && paper === '3' && level === 'hl') {
                 // Global Politics Paper 3 is HL only.
                 userQuery += ` For Global Politics HL Paper 3, generate TWO distinct compulsory essay questions (30 marks total). These questions must be concept-driven, focus on the prescribed HL case study of "${topic}", and require the application of political concepts (like power, legitimacy, human rights) and deep evaluation/synthesis. The entire response must strictly follow this structure, using ONLY HTML <b> tags for headings and line breaks, with no list markers:
    
                <b>Prescribed Case Study</b>
                [A brief, 2-3 sentence overview of the case study related to "${topic}"]
                
                <b>Question 1 (Compulsory)</b>
                [First 15-mark essay question, e.g., 'Discuss the effectiveness...']
                
                <b>Question 2 (Compulsory)</b>
                [Second 15-mark essay question, e.g., 'To what extent is the concept...']
                
                Ensure the questions are distinct and high-level.`;
            }
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: tools 
            };
            
            try {
                const response = await callGeminiApi(payload);
                const generatedText = response.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    APP_STATE.examPrompt = generatedText;
                    
                    // Determine duration based on paper selection
                    const configTime = config[`paper${paper}Time`];
                    APP_STATE.examDuration = configTime || 90 * 60; // Fallback
                    APP_STATE.timeRemaining = APP_STATE.examDuration;
                    
                    APP_STATE.step = 'EXAM_PREVIEW'; 
                } else {
                    APP_STATE.apiError = 'AI failed to generate a valid exam prompt.';
                }
            } catch (error) {
                // Error already logged and state updated in callGeminiApi
            }
            render();
        }

        /**
         * Grades the user's submitted answer using the Gemini API and a structured JSON output.
         */
        async function gradePaper() {
            const { subject, level, paper, examPrompt, userAnswer } = APP_STATE;
            if (!userAnswer.trim()) {
                APP_STATE.apiError = "Please write an essay before submitting for grading.";
                render();
                return;
            }

            // --- MAX MARKS CALCULATION ---
            let maxMarks;
            let rubric = SUBJECT_CONFIG[subject].rubric;
            if (subject === 'english') {
                maxMarks = 20; // 4 criteria * 5 marks
            } else if (subject === 'global_politics' && paper === '3') {
                maxMarks = 30; // 2 compulsory questions, often 15 marks each
                rubric = rubric.filter(r => ['Criterion A', 'Criterion B', 'Criterion C', 'Criterion D', 'Criterion E', 'Criterion F'].includes(r.name.split(':')[0]));
            } else { // GP Paper 1 or Paper 2
                maxMarks = 25; // Often 5 criteria * 5 marks (or similar combination)
                rubric = rubric.filter(r => ['Criterion A', 'Criterion B', 'Criterion C', 'Criterion D', 'Criterion E'].includes(r.name.split(':')[0]));
            }
            
            const config = SUBJECT_CONFIG[subject];
            const rubricText = rubric.map(c => `* ${c.name} (Max ${c.max} marks)`).join('\n');
            

            // --- SYSTEM PROMPT ---
            // Changed internal markdown bolding to <b> for visual consistency in the prompt
            const systemPrompt = `You are an expert IB examiner. You will grade the candidate's essay against the official IB ${config.name} ${level.toUpperCase()} Paper ${paper} rubric.
            
            The specific rubric criteria you must use are:
            ${rubricText}
            The total possible marks for this specific paper (P${paper}) is ${maxMarks}.

            CRITICAL: Based on the raw mark awarded (${maxMarks} total), you <b>MUST</b> determine the final overall IB grade on the official <b>1-7 scale</b> and provide it in the 'ibGradeLevel' field. Use typical, approximate IB grade boundaries for your conversion (e.g., 7 is typically 80%+, 6 is 70-79%, 5 is 60-69%, etc.).

            CRITICAL: The feedback in 'overallGradeComment' and all 'criteriaBreakdown' comments <b>MUST</b> be <b>highly specific and relevant</b> to the concepts and arguments presented in the candidate's answer. For each criterion's breakdown, you <b>MUST</b> include an \`exemplaryExcerpt\`. This must be a single, short, direct quote from the candidate's answer (1-3 sentences max) that either demonstrates the quality that earned the score or, if the score is low, showcases the specific issue or lack of development, <b>showing the student exactly where their mark was gained or lost.</b>

            CRITICAL: The criteria feedback <b>MUST</b> be returned as an array of objects within the 'criteriaBreakdown' field, where each object includes the 'criterionName' field matching the names listed above.

            Your response <b>MUST</b> strictly adhere to the provided JSON schema. Provide NO text, explanation, or commentary outside of the requested JSON object. For each criterion, provide a score from 0 to its maximum and a detailed comment justifying the score, specifically referencing the quality of the argument, textual/conceptual support, structure, and language. Your overallGradeComment must be a concise, professional summary.`;

            const userQuery = `
            IB Exam Prompt:
            ---
            ${examPrompt}
            ---

            Candidate's Answer:
            ---
            ${userAnswer}
            ---

            Grade the candidate's answer based on the IB rubric provided.
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            // Stop the timer if it's running
            if (APP_STATE.intervalId) clearInterval(APP_STATE.intervalId);

            APP_STATE.step = 'GRADING';
            render();
            
            try {
                const response = await callGeminiApi(payload, "application/json", GRADING_SCHEMA);
                const jsonText = response.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    const result = JSON.parse(jsonText);
                    APP_STATE.gradingResult = result;
                    APP_STATE.step = 'RESULTS';
                } else {
                    APP_STATE.apiError = 'AI failed to return a valid JSON grading result.';
                }
            } catch (error) {
                // Error already logged and state updated in callGeminiApi
            }
            render();
        }

        // --- Timer Functions ---

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }
        
        /**
         * Function to update only the timer display and its styling (no full re-render)
         */
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timerCard = document.getElementById('timerCard');

            if (timerDisplay && timerCard) {
                const isFinished = APP_STATE.timeRemaining <= 0;
                const timerColorClass = APP_STATE.timeRemaining < 300 ? 'text-red-300' : 'text-white'; // Red for last 5 mins
                
                timerDisplay.textContent = isFinished ? 'TIME UP!' : `${formatTime(APP_STATE.timeRemaining)}`;
                
                // Update classes on timer card only if they are different
                // Use a dedicated class for the default gradient background
                if (!timerCard.classList.contains('timer-card') && !timerCard.classList.contains('bg-red-700')) {
                    timerCard.classList.add('timer-card');
                } else if (APP_STATE.timeRemaining < 300 && !timerCard.classList.contains('bg-red-700')) {
                    timerCard.classList.remove('timer-card');
                    timerCard.classList.add('bg-red-700');
                } else if (APP_STATE.timeRemaining >= 300 && timerCard.classList.contains('bg-red-700')) {
                    timerCard.classList.remove('bg-red-700');
                    timerCard.classList.add('timer-card');
                }

                // Update text color
                timerDisplay.className = `text-4xl font-extrabold transition-colors duration-500 ${timerColorClass}`;
            }
        }

        function startTimer() {
            if (APP_STATE.intervalId) clearInterval(APP_STATE.intervalId);
            
            APP_STATE.intervalId = setInterval(() => {
                if (APP_STATE.timeRemaining > 0) {
                    APP_STATE.timeRemaining--;
                    updateTimerDisplay(); 
                } else {
                    clearInterval(APP_STATE.intervalId);
                    APP_STATE.intervalId = null; // Clear ID
                    
                    // Stop timer and save answer
                    const answerArea = document.getElementById('userAnswerArea');
                    if (answerArea) {
                        APP_STATE.userAnswer = answerArea.value;
                    }
                    
                    // Transition to grading state
                    APP_STATE.step = 'GRADING_INIT'; 
                    render(); 
                    
                    // Delay submission slightly to allow user to see "TIME UP!"
                    setTimeout(gradePaper, 5000); 
                }
            }, 1000);
        }

        // --- UI Rendering Functions ---

        /**
         * The main rendering function that updates the entire application based on APP_STATE.
         */
        function render() {
            const appDiv = document.getElementById('app');
            let content = '';
            
            // Determine key status for header display
            const isKeyConfigured = APP_STATE.apiKey && APP_STATE.apiKey.length > 20;

            // Shared components (Header updated to include API Key status/config button)
            const header = `
                <header class="w-full max-w-5xl mx-auto py-4 px-6 bg-white rounded-t-xl border-b-4 border-ib-blue-border shadow-md">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-gray-900">
                            <span class="ib-blue-text">IB Mock Exam Grader</span>
                        </h1>
                        <!-- Button now uses data-action for delegation -->
                        <button data-action="openKeyModal" class="flex items-center text-sm font-semibold p-2 rounded-full transition duration-300 hover:scale-[1.02] ${isKeyConfigured ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-red-100 text-red-700 hover:bg-red-200'}" title="Configure Gemini API Key">
                            <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14h-.01l-.743-.257A6 6 0 012 8c0-.663.078-1.309.227-1.936l-.888-.888a1 1 0 111.414-1.414l.888.888A7.96 7.96 0 0010 0a8 8 0 00-7.96 8c0 1.258.337 2.44 1.144 3.473L3.707 13H3a1 1 0 000 2h3a1 1 0 001-1v-3.793l3.646-3.647a1 1 0 011.414 0l3.647 3.647V14a1 1 0 001 1h3a1 1 0 000-2h-.707l-2.293-2.293A6 6 0 0118 8zm-8 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
                            ${isKeyConfigured ? 'Key Configured' : 'Configure Key'}
                        </button>
                    </div>
                    <p class="text-center sm:text-left text-sm opacity-70 text-gray-500 mt-2">Simulate Test Conditions & Receive AI-Powered IB Rubric Grading</p>
                </header>
            `;

            const loader = APP_STATE.isApiLoading ? `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white p-10 rounded-xl shadow-2xl flex flex-col items-center card no-hover-effect">
                        <div class="animate-spin rounded-full h-14 w-14 border-t-4 border-b-4 border-ib-blue-text mb-4"></div>
                        <p class="text-xl font-bold text-gray-800">${APP_STATE.step === 'GRADING' ? 'Grading your assessment...' : 'Preparing Exam Prompt...'}</p>
                        <p class="text-sm text-gray-500 mt-2">The AI Examiner is working hard. Please wait a moment.</p>
                    </div>
                </div>
            ` : '';
            
            const errorBox = APP_STATE.apiError ? `
                <div class="w-full max-w-5xl mx-auto p-4 mb-4 bg-red-50 border border-red-300 text-red-700 rounded-lg shadow-md" role="alert">
                    <p class="font-bold flex items-center"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg> API Error:</p>
                    <p class="mt-1">${APP_STATE.apiError}</p>
                    <button data-action="dismissError" class="mt-2 text-sm font-semibold text-red-800 underline">Dismiss</button>
                </div>
            ` : '';

            // Step-specific content
            if (APP_STATE.step === 'SUBJECT_SELECT') {
                content = renderSubjectSelect();
            } else if (APP_STATE.step === 'LEVEL_SELECT') {
                content = renderLevelSelect();
            } else if (APP_STATE.step === 'TOPIC_INPUT') {
                content = renderTopicInput();
            } else if (APP_STATE.step === 'PAPER_SELECT') {
                content = renderPaperSelect();
            } else if (APP_STATE.step === 'EXAM_PREVIEW') { 
                content = renderExamPreview();
            } else if (APP_STATE.step === 'EXAM_RUNNING') {
                content = renderExamRunning();
            } else if (APP_STATE.step === 'GRADING' || APP_STATE.step === 'GRADING_INIT') {
                 content = renderGradingPlaceholder();
            } else if (APP_STATE.step === 'RESULTS') {
                content = renderResults();
            }

            appDiv.innerHTML = header + errorBox + `<div class="w-full max-w-5xl mx-auto">${content}</div>` + loader;

            // Start timer if in EXAM_RUNNING state, and ensure it's not already running
            if (APP_STATE.step === 'EXAM_RUNNING' && APP_STATE.intervalId === null) {
                startTimer();
            }
            
            // Re-attach input listener for answer area if present
            const answerArea = document.getElementById('userAnswerArea');
            if (answerArea) {
                // Ensure the input handler updates state but does NOT trigger a full render loop
                answerArea.addEventListener('input', (e) => handleAnswerInput(e.target.value));
            }
        }

        // Helper components for each step

        function renderSubjectSelect() {
            return `
                <div class="card bg-white p-8 rounded-xl shadow-lg mt-6">
                    <h2 class="text-3xl font-bold mb-8 text-gray-800 border-b pb-3">1. Select Your Subject</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        ${Object.keys(SUBJECT_CONFIG).map(key => `
                            <button data-action="selectSubject" data-value="${key}" class="flex flex-col items-center justify-center p-8 border border-gray-200 rounded-xl transition duration-300 hover:bg-ib-blue/5 hover:border-ib-blue-border hover:shadow-xl group card">
                                <span class="text-6xl mb-3">${key === 'english' ? 'üìñ' : 'üèõÔ∏è'}</span>
                                <span class="text-xl font-bold ib-blue-text group-hover:text-blue-700">${SUBJECT_CONFIG[key].name}</span>
                                <span class="text-sm text-gray-500 mt-1">${key === 'english' ? 'Language & Literature' : 'Global Politics'}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderLevelSelect() {
            return `
                <div class="card bg-white p-8 rounded-xl shadow-lg mt-6">
                    <h2 class="text-3xl font-bold mb-8 text-gray-800 border-b pb-3">2. Select Your Level (${SUBJECT_CONFIG[APP_STATE.subject].name})</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        ${['sl', 'hl'].map(level => `
                            <button data-action="selectLevel" data-value="${level}" class="flex flex-col items-center justify-center p-8 border-4 rounded-xl transition duration-300 hover:bg-gray-100 hover:shadow-xl group card ${level === 'hl' ? 'border-red-400 hover:border-red-600' : 'border-green-400 hover:border-green-600'}">
                                <span class="text-5xl font-extrabold group-hover:text-black">${level.toUpperCase()}</span>
                                <span class="text-lg font-semibold text-gray-700 mt-2">(${level === 'hl' ? 'Higher Level' : 'Standard Level'})</span>
                            </button>
                        `).join('')}
                    </div>
                    <button data-action="backToSubjectSelect" class="mt-8 text-sm font-medium text-gray-500 hover:text-ib-blue-text transition duration-300 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Back to Subject Selection
                    </button>
                </div>
            `;
        }

        function renderTopicInput() {
            return `
                <div class="card bg-white p-8 rounded-xl shadow-lg mt-6">
                    <h2 class="text-3xl font-bold mb-8 text-gray-800 border-b pb-3">3. Enter Your Study Topic</h2>
                    <p class="text-gray-600 mb-6">Specify the core text or political issue you wish to be tested on. The AI will generate a prompt specific to this area.</p>
                    
                    <label for="topicInput" class="block text-sm font-medium text-gray-700 mb-2">Topic / Text / Issue:</label>
                    <input type="text" id="topicInput" value="${APP_STATE.topic}" placeholder="e.g., The Handmaid's Tale, The role of NGOs in conflict" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-ib-blue-border focus:border-ib-blue-border mb-8 text-lg shadow-sm">
                    
                    <button data-action="topicInputSubmit" class="w-full ib-blue text-white py-4 rounded-xl font-semibold text-lg transition duration-300 hover:bg-blue-800 shadow-md hover:shadow-lg">
                        Proceed to Paper Selection
                    </button>
                    <button data-action="backToLevelSelect" class="mt-4 text-sm font-medium text-gray-500 hover:text-ib-blue-text transition duration-300 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Back to Level Selection
                    </button>
                </div>
            `;
        }

        function renderPaperSelect() {
            const subjectConfig = SUBJECT_CONFIG[APP_STATE.subject];
            const isGP = APP_STATE.subject === 'global_politics';
            const isHL = APP_STATE.level === 'hl';
            
            const paperData = [
                { num: 1, title: 'Paper 1', subtitle: '(Unseen Text/Source Analysis)', time: formatTime(subjectConfig.paper1Time), available: true },
                { num: 2, title: 'Paper 2', subtitle: '(Comparative/Concept Essay)', time: formatTime(subjectConfig.paper2Time), available: true }
            ];
            
            if (isGP && isHL) {
                paperData.push({ 
                    num: 3, 
                    title: 'Paper 3 (HL Only)', 
                    subtitle: '(Prescribed Case Study Essay)', 
                    time: formatTime(subjectConfig.paper3Time), 
                    available: true 
                });
            }

            return `
                <div class="card bg-white p-8 rounded-xl shadow-lg mt-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">4. Select Exam Paper</h2>
                    <p class="text-lg font-medium text-gray-700 mb-6 border-b pb-3">Mock Exam: <span class="ib-blue-text font-bold">${subjectConfig.name} ${APP_STATE.level.toUpperCase()}</span> on topic: <span class="font-bold">${APP_STATE.topic}</span></p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 ${isGP && isHL ? 'lg:grid-cols-3' : ''} gap-6">
                        ${paperData.map(p => `
                            <button data-action="selectPaper" data-value="${p.num}" class="p-6 border-2 border-gray-200 rounded-xl transition duration-300 hover:bg-ib-blue/5 hover:border-ib-blue-border hover:shadow-xl group card flex flex-col items-center text-center">
                                <span class="text-3xl font-extrabold ib-blue-text">${p.title}</span>
                                <span class="text-base text-gray-600 mt-1">${p.subtitle}</span>
                                <span class="text-sm text-gray-400 mt-3">Duration: ${p.time}</span>
                            </button>
                        `).join('')}
                    </div>
                    <button data-action="backToTopicInput" class="mt-8 text-sm font-medium text-gray-500 hover:text-ib-blue-text transition duration-300 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Back to Topic Input
                    </button>
                </div>
            `;
        }

        function renderExamPreview() {
            const config = SUBJECT_CONFIG[APP_STATE.subject];
            const time = formatTime(config[`paper${APP_STATE.paper}Time`]);

            return `
                <div class="w-full mt-6 mb-8">
                    <!-- Title Bar (Placeholder for time/details) -->
                    <div class="flex flex-col sm:flex-row justify-between items-center p-4 rounded-t-xl bg-gray-200 text-gray-800 shadow-md">
                        <h2 class="text-xl sm:text-2xl font-bold tracking-tight mb-2 sm:mb-0">
                            ${config.name} P${APP_STATE.paper} (${APP_STATE.level.toUpperCase()})
                        </h2>
                        <div class="text-center sm:text-right">
                            <p class="text-sm font-medium opacity-80">Scheduled Duration</p>
                            <p class="text-3xl font-extrabold text-gray-700">${time}</p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 sm:p-8 rounded-b-xl shadow-2xl">
                        <!-- Exam Prompt Section -->
                        <div class="mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
                            <h3 class="text-xl font-bold mb-3 ib-blue-text flex items-center border-b pb-2">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13h2a2 2 0 002-2V7a2 2 0 00-2-2h-3m-6 11a1 1 0 100 2 1 1 0 000-2zm12 0a1 1 0 100 2 1 1 0 000-2z"></path></svg>
                                The Exam Prompt (Review Carefully before starting)
                            </h3>
                            <!-- Display content in a div to allow HTML <b> tags to render, while preserving line breaks -->
                            <div 
                                id="examPromptDisplay"
                                class="w-full p-4 border border-gray-300 rounded-xl bg-gray-100 text-base text-gray-700 leading-relaxed shadow-inner overflow-auto max-h-96 preserve-whitespace"
                            >
                                ${APP_STATE.examPrompt}
                            </div>
                        </div>

                        <!-- Start Exam Button -->
                        <div class="mt-8">
                            <button data-action="startExam" class="w-full py-5 rounded-xl font-extrabold text-2xl transition duration-300 ib-blue text-white hover:bg-blue-800 shadow-lg hover:shadow-xl flex items-center justify-center">
                                <svg class="w-7 h-7 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.108a12.022 12.022 0 011.666 1.485v5.378a2 2 0 01-2 2h-2.585a2 2 0 00-1.415.585L12 21.033l-1.618-1.618a2 2 0 00-1.415-.585H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1"></path></svg>
                                Start Timed Exam Now
                            </button>
                        </div>
                        <p class="text-sm text-red-600 mt-4 font-medium text-center"><b>Warning:</b> The timer (${time}) will start immediately upon clicking this button and cannot be paused.</p>
                        <button data-action="backToPaperSelect" class="mt-4 text-sm font-medium text-gray-500 hover:text-ib-blue-text transition duration-300 flex items-center mx-auto">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            Back to Paper Selection
                        </button>
                    </div>
                </div>
            `;
        }

        function handleAnswerInput(value) {
            // Update the state immediately when the user types, but DO NOT call render()
            APP_STATE.userAnswer = value;
        }

        function renderExamRunning() {
            const isFinished = APP_STATE.timeRemaining <= 0;
            const timerColor = APP_STATE.timeRemaining < 300 ? 'text-red-300' : 'text-white'; // Red for last 5 mins
            const timerBg = APP_STATE.timeRemaining < 300 ? 'bg-red-700 shadow-xl' : 'timer-card shadow-xl';

            return `
                <div class="w-full mt-6 mb-8">
                    <!-- Timer and Title Bar -->
                    <div id="timerCard" class="flex flex-col sm:flex-row justify-between items-center p-4 rounded-t-xl ${timerBg} text-white transition-all duration-500">
                        <h2 class="text-xl sm:text-2xl font-bold tracking-tight mb-2 sm:mb-0">
                            ${SUBJECT_CONFIG[APP_STATE.subject].name} P${APP_STATE.paper} (${APP_STATE.level.toUpperCase()})
                        </h2>
                        <div class="text-center sm:text-right">
                            <p class="text-sm font-medium opacity-80">Exam Time Remaining</p>
                            <p id="timerDisplay" class="text-4xl font-extrabold ${timerColor} transition-colors duration-500">
                                ${isFinished ? 'TIME UP!' : `${formatTime(APP_STATE.timeRemaining)}`}
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 sm:p-8 rounded-b-xl shadow-2xl">
                        <!-- Exam Prompt Section -->
                        <div class="mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
                            <h3 class="text-xl font-bold mb-3 ib-blue-text flex items-center border-b pb-2">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13h2a2 2 0 002-2V7a2 2 0 00-2-2h-3m-6 11a1 1 0 100 2 1 1 0 000-2zm12 0a1 1 0 100 2 1 1 0 000-2z"></path></svg>
                                The Exam Prompt
                            </h3>
                            <!-- Display content in a div to allow HTML <b> tags to render, while preserving line breaks -->
                            <div 
                                id="examPromptDisplay"
                                class="w-full p-4 border border-gray-300 rounded-xl bg-gray-100 text-base text-gray-700 leading-relaxed shadow-inner overflow-auto max-h-96 preserve-whitespace"
                            >
                                ${APP_STATE.examPrompt}
                            </div>
                        </div>

                        <!-- Answer Area Section -->
                        <div class="mt-8">
                            <h3 class="text-xl font-bold mb-3 text-gray-800 flex items-center border-b pb-2">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                Your Written Response
                            </h3>
                            <textarea 
                                id="userAnswerArea" 
                                rows="20" 
                                class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-ib-blue-border focus:border-ib-blue-border text-base shadow-inner transition duration-200" 
                                placeholder="Start writing your high-quality essay response here. Pay attention to the structure, use of evidence/examples, and sophisticated language appropriate for the IB level."
                            >${APP_STATE.userAnswer}</textarea>
                        </div>
                        
                        <button data-action="submitAnswer" ${isFinished ? 'disabled' : ''} class="mt-8 w-full py-4 rounded-xl font-semibold text-xl transition duration-300 ${isFinished ? 'bg-gray-400 cursor-not-allowed' : 'ib-blue text-white hover:bg-blue-800 shadow-lg hover:shadow-xl'}">
                            ${isFinished ? 'Time Expired - Submitting' : 'Submit for Grading'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderGradingPlaceholder() {
            return `
                <div class="card bg-white p-12 rounded-xl shadow-lg mt-6 text-center no-hover-effect">
                    <div class="animate-pulse">
                        <svg class="w-16 h-16 mx-auto ib-blue-text mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.108a12.022 12.022 0 011.666 1.485v5.378a2 2 0 01-2 2h-2.585a2 2 0 00-1.415.585L12 21.033l-1.618-1.618a2 2 0 00-1.415-.585H5a2 2 0 01-2-2v-5.378a12.023 12.023 0 011.666-1.485m6.877 4.167a5.002 5.002 0 01-6.814-2.858 5.002 5.002 0 012.857-6.814 5.002 5.002 0 016.814 2.857 5.002 5.002 0 01-2.857 6.814z"></path></svg>
                        <h2 class="text-3xl font-bold ib-blue-text mb-4">Grading in Progress...</h2>
                        <p class="text-xl text-gray-600">The AI Examiner is meticulously applying the official IB Rubric to your response, focusing on conceptual clarity and analytical depth.</p>
                    </div>
                    <div class="mt-10 text-left max-w-md mx-auto p-4 bg-gray-100 rounded-lg">
                        <p class="font-semibold text-gray-800 border-b pb-2 mb-2">Currently Reviewing Criteria:</p>
                        <ul class="space-y-1 text-sm text-gray-600">
                            ${SUBJECT_CONFIG[APP_STATE.subject].rubric.map(c => `<li class="flex items-center"><span class="ib-blue-text font-bold mr-2">‚Ä¢</span>${c.name} (Max ${c.max})</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }


        function renderResults() {
            const result = APP_STATE.gradingResult;
            const config = SUBJECT_CONFIG[APP_STATE.subject];
            
            // --- VERIFIED MAX SCORE DISPLAY ---
            let maxScore = result.totalMarksPossible || 20; // Default to 20 if property is missing for safety
            
            const achievedScore = result.totalMarksAchieved;
            const ibGrade = result.ibGradeLevel; // NEW: Fetching the 1-7 grade
            const percentage = ((achievedScore / maxScore) * 100).toFixed(1);
            
            // Color based on 1-7 grade
            const gradeColor = ibGrade >= 6 ? 'text-green-600' : ibGrade >= 4 ? 'text-yellow-600' : 'text-red-600';

            return `
                <div class="card bg-white p-8 rounded-xl shadow-lg mt-6">
                    <h2 class="text-4xl font-extrabold mb-8 text-center text-gray-800 border-b-2 pb-4">Mock Exam Results & Examiner Report</h2>
                    
                    <!-- Score Summary Card -->
                    <div class="bg-ib-blue/10 p-6 rounded-xl border-2 border-ib-blue-border mb-10 text-center">
                        <p class="text-xl font-semibold text-gray-700">Final Mark Awarded (Raw Score):</p>
                        <p class="text-6xl font-black mt-2 ib-blue-text transition-colors duration-500 ${gradeColor}">${achievedScore}</p>
                        <p class="text-2xl font-bold text-gray-600">out of ${maxScore} (<span class="font-black">${percentage}%</span>)</p>
                        
                        <!-- NEW: IB GRADE 1-7 -->
                        <div class="mt-6 border-t pt-4 border-ib-blue-border">
                            <p class="text-xl font-semibold text-gray-700">Overall IB Grade:</p>
                            <p class="text-8xl font-black mt-2 ib-gold-text">${ibGrade}</p>
                            <p class="text-base text-gray-500 mt-1">(On the official 1-7 IB Scale)</p>
                        </div>
                    </div>

                    <!-- Examiner's Overall Comment -->
                    <div class="mb-10 p-6 border-l-4 border-ib-blue-border bg-gray-50 rounded-lg">
                        <h3 class="text-2xl font-bold mb-3 text-gray-800 flex items-center">
                            <svg class="w-6 h-6 mr-2 ib-blue-text" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-6-6H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v12a2 2 0 01-2 2h-4l-6 6z"></path></svg>
                            Overall Examiner's Feedback
                        </h3>
                        <p class="text-gray-700 whitespace-pre-wrap leading-relaxed mt-4">${result.overallGradeComment}</p>
                    </div>

                    <!-- Criteria Breakdown -->
                    <div class="mb-10">
                        <h3 class="text-2xl font-bold mb-5 text-gray-800 border-b pb-3">Detailed Rubric Breakdown</h3>
                        ${result.criteriaBreakdown.map(criterion => { 
                            const critKey = criterion.criterionName; 
                            const max = config.rubric.find(r => critKey.includes(r.name.split(':')[0]))?.max || 5; 
                            const critColor = criterion.score / max >= 0.8 ? 'bg-green-100 text-green-700' : criterion.score / max >= 0.5 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700';
                            return `
                                <div class="p-4 mb-4 bg-white rounded-xl border border-gray-200 shadow-sm transition duration-300 hover:shadow-md">
                                    <div class="flex justify-between items-start mb-2">
                                        <p class="font-semibold text-lg text-gray-900">${critKey}</p>
                                        <div class="flex-shrink-0">
                                            <span class="text-xl font-extrabold py-1 px-3 rounded-full ${critColor}">${criterion.score} / ${max}</span>
                                        </div>
                                    </div>
                                    <p class="text-base text-gray-600 mt-1 italic leading-relaxed">
                                        <span class="font-medium text-gray-700">Comment:</span> ${criterion.comment}
                                    </p>
                                    
                                    <!-- Excerpt showing WHERE the mark was earned/lost -->
                                    <div class="mt-3 pt-3 border-t border-gray-100">
                                        <p class="text-sm font-semibold text-gray-800 mb-1 flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-ib-blue-text" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-2.414-2.414A1 1 0 0015.586 6H7a2 2 0 00-2 2v11a2 2 0 002 2z"></path></svg>
                                            Excerpt from your work:
                                        </p>
                                        <blockquote class="pl-4 border-l-4 border-yellow-500 italic text-gray-500 bg-yellow-50/50 p-2 rounded-md text-base">
                                            "${criterion.exemplaryExcerpt || 'No specific excerpt was provided for this criterion.'}"
                                        </blockquote>
                                    </div>
                                    
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Improvement Section -->
                    <div class="mb-8 p-6 bg-ib-blue/5 rounded-xl border-2 border-ib-blue-border shadow-inner">
                        <h3 class="text-2xl font-bold mb-3 ib-blue-text flex items-center">
                             <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                             Suggested Strategies for Improvement
                        </h3>
                        <p class="text-gray-700 whitespace-pre-wrap leading-relaxed mt-4">${result.suggestedImprovementEssay}</p>
                    </div>

                    <!-- Reset Button -->
                    <button data-action="resetApp" class="w-full py-4 rounded-xl font-semibold text-xl transition duration-300 bg-gray-800 text-white hover:bg-gray-700 shadow-lg hover:shadow-xl">
                        Start New Mock Exam Session
                    </button>
                </div>
            `;
        }
        
        // --- Event Handlers (Called by Delegation) ---

        function handleSubjectSelect(subject) {
            APP_STATE.subject = subject;
            APP_STATE.step = 'LEVEL_SELECT';
            render();
        }

        function handleLevelSelect(level) {
            APP_STATE.level = level;
            APP_STATE.step = 'TOPIC_INPUT';
            render();
        }

        function handleTopicInput() {
            const input = document.getElementById('topicInput').value.trim();
            if (input.length < 3) {
                APP_STATE.apiError = "Please enter a specific topic or text (minimum 3 characters).";
                render();
                return;
            }
            APP_STATE.topic = input;
            APP_STATE.step = 'PAPER_SELECT';
            render();
        }

        function handlePaperSelect(paper) {
            APP_STATE.paper = paper;
            generateExamPrompt();
        }
        
        function handleStartExam() {
            APP_STATE.step = 'EXAM_RUNNING';
            render(); 
        }
        
        function handleSubmitAnswer() {
            // Stop the timer and save the final answer
            if (APP_STATE.intervalId) clearInterval(APP_STATE.intervalId);
            APP_STATE.intervalId = null;

            const answerArea = document.getElementById('userAnswerArea');
            if (answerArea) {
                APP_STATE.userAnswer = answerArea.value;
            }
            
            // Proceed to grading
            gradePaper();
        }
        
        function resetApp() {
            if (APP_STATE.intervalId) clearInterval(APP_STATE.intervalId);
            APP_STATE.intervalId = null;

            // Preserve the API Key across resets
            Object.assign(APP_STATE, {
                step: 'SUBJECT_SELECT',
                subject: null,
                level: null,
                topic: '',
                paper: null,
                examDuration: 0,
                timeRemaining: 0,
                userAnswer: '',
                gradingResult: null,
                isApiLoading: false,
                apiError: null,
            });
            render();
        }
        
        // --- CORE EVENT DELEGATION LOGIC (Refined for robustness) ---

        function handleDelegatedClick(event) {
            // Use closest() to find the element with data-action, starting from the click target
            const targetActionElement = event.target.closest('[data-action]');

            // Check if click is on the modal backdrop to close it
            const modal = document.getElementById('apiKeyModal');
            if (modal && !modal.classList.contains('modal-hidden') && event.target.id === 'apiKeyModal') {
                 closeKeyModal();
                 return;
            }

            if (!targetActionElement) return;

            const action = targetActionElement.dataset.action;
            const value = targetActionElement.dataset.value;

            // Handle actions
            switch (action) {
                case 'openKeyModal':
                    openKeyModal();
                    break;
                case 'saveApiKey':
                    saveApiKey();
                    break;
                case 'dismissError':
                    APP_STATE.apiError = null; 
                    render();
                    break;
                case 'selectSubject':
                    handleSubjectSelect(value);
                    break;
                case 'selectLevel':
                    handleLevelSelect(value);
                    break;
                case 'backToSubjectSelect':
                    APP_STATE.step='SUBJECT_SELECT'; 
                    render();
                    break;
                case 'topicInputSubmit':
                    handleTopicInput();
                    break;
                case 'backToLevelSelect':
                    APP_STATE.step='LEVEL_SELECT'; 
                    render();
                    break;
                case 'selectPaper':
                    handlePaperSelect(value);
                    break;
                case 'startExam':
                    handleStartExam();
                    break;
                case 'backToPaperSelect':
                    APP_STATE.step='PAPER_SELECT'; 
                    render();
                    break;
                case 'submitAnswer':
                    handleSubmitAnswer();
                    break;
                case 'resetApp':
                    resetApp();
                    break;
                default:
                    console.warn('Unhandled action:', action);
            }
        }
        
        /**
         * Sets up the single, delegated click listener on the entire document body.
         * This ensures clicks on elements outside the main #app container (like modals) are caught.
         */
        function setupDelegation() {
            // Attaching to document.body covers all elements, including the modal.
            document.body.addEventListener('click', handleDelegatedClick);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupDelegation();
            render();
        });

    </script>
</body>
</html>
